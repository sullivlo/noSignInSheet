<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Sample FirebaseUI App</title>

    </head>
    
    <body>
        <!-- sign in widget from firebase UI web-->
        <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
        <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyC9Os_I1RJe3ZIf0_0cDvxTzNzwff_kxJI",
            authDomain: "nosigninsheet.firebaseapp.com",
            databaseURL: "https://nosigninsheet.firebaseio.com",
            projectId: "nosigninsheet",
            storageBucket: "nosigninsheet.appspot.com",
            messagingSenderId: "239648283120"
        };
        firebase.initializeApp(config);


         // Get a reference to the database service
        var database = firebase.database();
        console.log(database);
        // Get a reference to the database root
        var root = database.ref();
        console.log(root);
        // Create child node
        var classRoot = root.child("classes");
        console.log(classRoot);
        
        
        

        showFirebaseTable();
        
        
        function showFirebaseTable(){

            classRoot.on("child_added", function(snapshot){
            //    console.log(snapshot.key);
            //    console.log(snapshot.val());

            var mySnap =snapshot.val();

            var myKey  = snapshot.key;
            console.log("myKey "+ myKey);
            console.log(mySnap);

              

            var Classkey = "classes/"+myKey

            helpBuildTable(mySnap.className, mySnap.teacher, Classkey);
         
        });
        }
                
        
        </script>

        <!-- *******************************************************************************************
        * TODO(DEVELOPER): Paste the initialization snippet from:
        * Firebase Console > Overview > Add Firebase to your web app. *
        ***************************************************************************************** -->
        <script type="text/javascript">
            

            initApp = function() {
                firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in.
                    console.log("sign in");

                   
                    var displayName = user.displayName;
                    
                    var email = user.email;
                    var emailVerified = user.emailVerified;
                    var photoURL = user.photoURL;
                    var uid = user.uid;
                    var phoneNumber = user.phoneNumber;
                    var providerData = user.providerData;
                    user.getIdToken().then(function(accessToken) {
                    ////document.getElementById('sign-in-status').textContent = 'Signed in';
                    //document.getElementById('sign-in').textContent = 'Sign out';      

                    var _userInfo = JSON.stringify({
                        displayName: displayName,
                        email: email,
                        emailVerified: emailVerified,
                        phoneNumber: phoneNumber,
                        photoURL: photoURL,
                        uid: uid,
                        accessToken: accessToken,
                        providerData: providerData
                    }, null, '  ');

                    // render the user screen with login information                  
                    userHandler(displayName, email);
                     
                    
                    });
                } else {
                    // User is signed out.
                    console.log("sign out");
                    ////document.getElementById('sign-in-status').textContent = 'Signed out';
                    //document.getElementById('sign-in').textContent = 'Sign in';
                    ////document.getElementById('account-details').textContent = 'null';
                }
                }, function(error) {
                console.log(error);
                });
            };

            window.addEventListener('load', function() {
                initApp()
            });

            function addRowFireBase(MydisplayName, myClass, myEmail){

                classRoot.push().set({
                teacher: MydisplayName,
                className: myClass,
                email: myEmail

                
                });  
            }

            //called from submit button
            function addClassName(){
                console.log("in add class name");
                var myClassName = document.getElementById("ib_ClassName").value;
                console.log(myName + ' ' + myEmail);
                addRowFireBase(myName, myClassName, myEmail);
                
            }
            
            // user variables
            var myName = null;
            var myEmail = null;

            // set the user variables
            // bad implementation but google auth user can not be reference
            //  w/o passing user handler the user's info
            function userHandler(name, email){
                myName = name;
                myEmail = email;
                
            }
            
            //allows the teacher to create a new session
            // to call this function pass a reference to the
            // class toDo: pass by myRefToMyClass
            function addSession(){
                var myRoot =  "-LRKV1nezHnu3JcYdCm0";

                var myRef = "classes/"+myRoot
                
                // Have to push child session before it it created in firebase
                var nameRef = root.child(myRef);
                var nameRef = nameRef.child("sessions");
                console.log(nameRef);
                // toDo: pass the teachers current gps location
                nameRef.push().set({
                    location: "MyLocation",
                    students: "Louis Sullivan",
                    totalAttendees: "0",
                    date: "11/14/2018"

                });
            }

            /*******
            * allows the student to add them selves to a class
            * to call this function 
            * pass the class reference to root
            ********/
            function addStudent(myRoot){

                /**
                    get the current class reference from the root 
                */
                var nameRef = root.child(myRoot);
                
                /****
                * push students to current class node
                *  Have to push child students before it it created in firebase
                ******/
                var studentRef = nameRef.child("students");
                console.log(myEmail);

                console.log(studentRef);
                
                /*
                * Pass the current users emal, name to the class student list
                */
                studentRef.push().set({
                    name: myName,
                    email: myEmail

                });
            }
            
            /*****
            * Build the table using the firebase data
            *
            *******/
            function helpBuildTable(className, email, Classkey){

                var tmp = "<input type= \"submit\" value=\"Add my self to class\" onclick=\"addStudent('"+ Classkey + "')\"/>";
            
                document.getElementById("myTable").innerHTML += "<tr id = "+ Classkey + " ><td>" + className + "</td><td>" +
                    email + "</td>"+ "<td>" + tmp + "</td>" +"</tr>";
            }
 
        </script>
    
    
        <h1>Welcome to My Awesome App</h1>
        <div id="sign-in-status">
            
        </div>
        <img id = "userImg" src="" />
        <div id="sign-in"></div>
        <div id="account-details"></div>
        
        Class name: <input id= "ib_ClassName" type="text" name="FirstName" value=""><br>
        <input type="submit" value="addClass" onclick="addClassName()">
        <br><br><br>
        <input type="submit" value="addSessionToClass" onclick="addSession()"> 

        <br><br><br>
        <input type="submit" value="addStudentsToClass" onclick="addStudent()">

        <table id = myTable>
            <tr><th>Class Name</th><th>Email</th><th>Class Key</th></tr>
        </table>
        
       

            
        
  </body>
